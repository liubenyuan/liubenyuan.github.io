<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
  "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
<meta name="generator" content="jemdoc, see http://jemdoc.jaboc.net/" />
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<link rel="stylesheet" href="jemdoc.css" type="text/css" />
<title></title>
</head>
<body>
<table summary="Table for page layout." id="tlayout">
<tr valign="top">
<td id="layout-menu">
<div class="menu-item"><a href="index.html">Main</a></div>
<div class="menu-item"><a href="publications.html">Publications</a></div>
<div class="menu-category">Research</div>
<div class="menu-item"><a href="bsbl.html">BSBL</a></div>
<div class="menu-item"><a href="eit.html" class="current">EIT</a></div>
<div class="menu-item"><a href="connectomics.html">Connectomics</a></div>
<div class="menu-item"><a href="nircm.html">NIRCM</a></div>
<div class="menu-category">Hacks</div>
<div class="menu-item"><a href="phealth.html">phealth</a></div>
<div class="menu-item"><a href="kicad.html">kicad</a></div>
<div class="menu-item"><a href="radar.html">radar</a></div>
<div class="menu-item"><a href="nudtpaper.html">nudtpaper</a></div>
<div class="menu-item"><a href="atmel.html">atmel</a></div>
<div class="menu-item"><a href="nrf51822.html">nrf51822</a></div>
<div class="menu-item"><a href="flexbot.html">flexbot</a></div>
<div class="menu-item"><a href="msp430.html">msp430</a></div>
</td>
<td id="layout-content">
<h1>EIT &ndash; Electrical Impedance Tomography</h1>
<p>Hardware/Software</p>
<h1>NIR &ndash; Near Infra-Red Monitoring</h1>
<h2>NIR &ndash; the hardware</h2>
<p><b>Pmod J4 :</b> right panel (look into the holes)</p>
<table id="NIR Pin set -- J4">
<tr class="r1"><td class="c1"><b>1</b> </td><td class="c2"> <b>2</b> </td><td class="c3"> <b>3</b> </td><td class="c4"> <b>4</b> </td><td class="c5"> <b>5</b> </td><td class="c6"> <b>6</b> </td></tr>
<tr class="r2"><td class="c1">D8 </td><td class="c2"> D6 </td><td class="c3"> D7 </td><td class="c4"> D5 </td><td class="c5"> <tt>GND</tt> </td><td class="c6"> <tt>VCC</tt> </td></tr>
<tr class="r3"><td class="c1">FRV </td><td class="c2"> D9 </td><td class="c3"> EXP </td><td class="c4"> LIV </td><td class="c5"> - </td><td class="c6"> - </td></tr>
<tr class="r4"><td class="c1"><b>7</b> </td><td class="c2"> <b>8</b> </td><td class="c3"> <b>9</b> </td><td class="c4"> <b>10</b> </td><td class="c5"> <b>11</b> </td><td class="c6"> <b>12</b>
</td></tr></table>
<p><b>Pmod J5 :</b> left panel (look into the holes)</p>
<table id="NIR Pin set -- J4">
<tr class="r1"><td class="c1"><b>1</b> </td><td class="c2"> <b>2</b> </td><td class="c3"> <b>3</b> </td><td class="c4"> <b>4</b> </td><td class="c5"> <b>5</b> </td><td class="c6"> <b>6</b> </td></tr>
<tr class="r2"><td class="c1">D2 </td><td class="c2"> XCK </td><td class="c3"> D4 </td><td class="c4"> SCK </td><td class="c5"> <tt>GND</tt> </td><td class="c6"> <tt>VCC</tt> </td></tr>
<tr class="r3"><td class="c1">PCK </td><td class="c2"> D3 </td><td class="c3"> LED </td><td class="c4"> SDA </td><td class="c5"> - </td><td class="c6"> - </td></tr>
<tr class="r4"><td class="c1"><b>7</b> </td><td class="c2"> <b>8</b> </td><td class="c3"> <b>9</b> </td><td class="c4"> <b>10</b> </td><td class="c5"> <b>11</b> </td><td class="c6"> <b>12</b>
</td></tr></table>
<p>We wire (where FPGA is the master)</p>
<table id="ucf definition">
<tr class="r1"><td class="c1"><b>Port</b> </td><td class="c2"> <b>MT9V034-devboard</b> </td><td class="c3"> <b>IO (FPGA is the master)</b> </td><td class="c4"> <b>Annotation</b> </td></tr>
<tr class="r2"><td class="c1">DCMI_SYS_CLK </td><td class="c2"> XCK </td><td class="c3"> Output </td><td class="c4"> <b>system clock</b> </td></tr>
<tr class="r3"><td class="c1">DCMI_CLK </td><td class="c2"> PCK </td><td class="c3"> Input </td><td class="c4"> <b>Data clock</b> </td></tr>
<tr class="r4"><td class="c1">DCMI_EXP </td><td class="c2"> EXP </td><td class="c3"> Output </td><td class="c4"> <b>Exposure</b> </td></tr>
<tr class="r5"><td class="c1">DCMI_DATA&lt;7:0&gt; </td><td class="c2"> D9 &ndash; D2 </td><td class="c3"> Input </td><td class="c4"> <b>Data</b> </td></tr>
<tr class="r6"><td class="c1">DCMI_HSYNC </td><td class="c2"> LIV </td><td class="c3"> Input </td><td class="c4"> <b>Line valid</b> </td></tr>
<tr class="r7"><td class="c1">DCMI_VSYNC </td><td class="c2"> FRV </td><td class="c3"> Input </td><td class="c4"> <b>Frame valid</b> </td></tr>
<tr class="r8"><td class="c1">DCMI_LED </td><td class="c2"> LED </td><td class="c3"> Input </td><td class="c4"> </td></tr>
<tr class="r9"><td class="c1">DCMI_SCK </td><td class="c2"> SCK </td><td class="c3"> Output </td><td class="c4"> </td></tr>
<tr class="r10"><td class="c1">DCMI_SDA </td><td class="c2"> SDA </td><td class="c3"> Inout </td><td class="c4">
</td></tr></table>
<div class="infoblock">
<div class="blockcontent">
<p>By comparing PX4Flow and the MT9v034 taobao board, we found some common connections, <tt>OE</tt> (active HIGH) tied to VCC, <tt>RSVD</tt> tied to GND. <tt>BYPASS_CLKIN_P</tt> and <tt>SER_DATAIN_P</tt> are tied to GND, while <tt>BYPASS_CLKIN_N</tt> and <tt>SER_DATAIN_N</tt> are tied to VCC with 1k Ohm pull-up resistor.</p>
<p>However, for MT9v034-dev, the <tt>STANDBY</tt> is tied to GND, and the <tt>RESET_N</tt> is tied to VCC with 10k Ohm pull-up resistor. For PX4Flow, these two pins are controlled by MCU. For mt9v034-dev, <tt>SCTRL_ADDR0</tt> and <tt>SCTRL_ADDR1</tt> are tied to GND, while for PX4Flow, these pins are tied to VCC.</p>
<p>These two boards works in master mode, with steroscopy mode disabled. <tt>SCK</tt> and <tt>SDA</tt> should be pulled-up with 1.5K Ohm resistors when no other I2C peripheral is connected.</p>
</div></div>
<h2>NIR &ndash; boot mt9v034</h2>
<p>In principles, the mt9v034 works <tt>output wide-VGA image at 60fps</tt> by default.</p>
<div class="infoblock">
<div class="blockcontent">
<p>By injecting <tt>DCMI_SYS_CLK</tt> with 25MHz clock input, and trigger <tt>DCMI_EXP</tt> with a rising-edge sensitive pulse (<b>1000</b> cycles duty period, in snapshot or slave mode; in master mode, <tt>DCMI_EXP</tt> may tie to GND). We may monitor the <tt>DCMI_DATA</tt> bus, <tt>DCMI_HSYNC</tt> and <tt>DCMI_VSYNC</tt> signals, as well as <tt>DCMI_LED</tt> pins.</p>
<p><tt>DCMI_VSYNC</tt> is HIGH valid during the whole imaging process (a frame), <tt>DCMI_HSYNC</tt> is periodorically HIGH valid. The image format is <b>752x480</b>. However, currently <tt>DCMI_CLK</tt> could not register exactly <tt>752</tt> datum each <b>HSYNC</b> pules. <i>(need debug this)</i>. Strange, <tt>DCMI_CLK</tt> may be <b>26.6</b>MHz PLL locked even if we inject a <b>25</b>MHz <tt>DCMI_SYS_CLK</tt>.</p>
</div></div>
<h2>NIR &ndash; config mt9v034</h2>
<p>With <tt>ADDR0</tt> and <tt>ADDR1</tt> pins pulled low on mt9v034-dev, the address is <tt>0x48</tt>, with the last bit denotes write (&rsquo;0&rsquo;) or read (&rsquo;1&rsquo;). Therefore, the mt9v034 board has <tt>0x90</tt> for write, <tt>0x91</tt> for read.</p>
<p>We port the source code <tt>mt9v034.c</tt> in PX4Flow to NIR project, (<tt>Context A</tt>, context, is like a fast register switching machanism, Context B in PX4Flow is used for video capture only, while context A is for practical optical flow usage)</p>
<table id="mt9v034.c">
<tr class="r1"><td class="c1"><b>Register</b> </td><td class="c2"> <b>Name</b> </td><td class="c3"> <b>Default</b> </td><td class="c4"> <b>Context A (Context B)</b> </td><td class="c5"> <b>Shadow Reg</b> </td><td class="c6"> <b>Annotation</b> </td></tr>
<tr class="r2"><td class="c1">0x07 </td><td class="c2"> Chip Control </td><td class="c3"> 0x0388 </td><td class="c4"> 0x0188 (0x8188) </td><td class="c5"> Y </td><td class="c6"> <b>Normal</b> operation </td></tr>
<tr class="r3"><td class="c1">0x01 </td><td class="c2"> Column Start </td><td class="c3"> 1 </td><td class="c4"> (752 - 64*4)/2 + 1 </td><td class="c5"> Y </td><td class="c6"> Center Window </td></tr>
<tr class="r4"><td class="c1">0x02 </td><td class="c2"> Row Start </td><td class="c3"> 4 </td><td class="c4"> (480 - 64*4)/2 + 4 </td><td class="c5"> N </td><td class="c6"> </td></tr>
<tr class="r5"><td class="c1">0x03 (OxCB)</td><td class="c2"> WINDOW_HEIGHT </td><td class="c3"> 480 </td><td class="c4"> 64*4 (120*4) </td><td class="c5"> Y </td><td class="c6"> 4-binning </td></tr>
<tr class="r6"><td class="c1">0x04 (0xCC) </td><td class="c2"> WINDOW_WIDTH </td><td class="c3"> 752 </td><td class="c4"> 64*4 (188*4) </td><td class="c5"> N </td><td class="c6"> </td></tr>
<tr class="r7"><td class="c1">0x05 </td><td class="c2"> Hor Blanking </td><td class="c3"> 4 + 91 </td><td class="c4"> (752 - 64*4) + 91 </td><td class="c5"> Y </td><td class="c6"> </td></tr>
<tr class="r8"><td class="c1">0x06 </td><td class="c2"> Ver Blanking </td><td class="c3"> 45 </td><td class="c4"> 10 </td><td class="c5"> N </td><td class="c6"> </td></tr>
<tr class="r9"><td class="c1">0x0D (0x0E) </td><td class="c2"> Read Mode </td><td class="c3"> 0x300 </td><td class="c4"> 0x30A (0x305) </td><td class="c5"> Y </td><td class="c6"> row bin-4, col bin-4
</td></tr></table>
<p>We build dedicated module <tt>mt9v034_io.vhd</tt> to handle the Read Write process to MT9v034,</p>
<table id="mt9v034 IO">
<tr class="r1"><td class="c1">0x90 (0x91) </td><td class="c2"> REG_ADDRESS </td><td class="c3"> WB1 (RB0) </td><td class="c4"> WB2 (RB0)
</td></tr></table>
<p>for example, <tt>0x90070188</tt> write 0x0188 to 0x07 in mt9v034, <tt>0x9107XXXX</tt> read DBYTE from 0x07 in mt9v034.</p>
<h2>NIR &ndash; implementation</h2>
<div id="footer">
<div id="footer-text">
Page generated 2014-06-13 20:56:53 UTC, by <a href="http://jemdoc.jaboc.net/">jemdoc</a>.
</div>
</div>
</td>
</tr>
</table>
</body>
</html>
