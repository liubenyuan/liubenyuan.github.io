<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
  "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
<meta name="generator" content="jemdoc, see http://jemdoc.jaboc.net/" />
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<link rel="stylesheet" href="metro_style/metro-bootstrap.css" media="screen">
<link rel="stylesheet" href="private.css" media="screen">
<script src="metro_style/jquery.min.js"></script>
<script src="metro_style/jquery.widget.min.js"></script>
<script src="metro_style/metro.min.js"></script>
<title></title>
</head>
<body class="metro">
<header class="bg-light">
<div class="navigation-bar light">
<div class="navigation-bar-content container">
<nav class="horizontal-menu"><ul class="element-menu">
<li><a href="index.html">Main</a></li>
<li><a href="publications.html">Publications</a></li>
<li><a class="dropdown-toggle" href="#">Research</a>
<ul class="dropdown-menu" data-role="dropdown">
<li><a href="bsbl.html">BSBL</a></li>
<li><a href="eit.html">EIT</a></li>
<li><a href="connectomics.html">Connectomics</a></li>
<li><a href="nircm.html">NIRCM</a></li>
<li><a href="phealth.html">phealth</a></li>
</ul></li>
<li><a class="dropdown-toggle" href="#">Hacks</a>
<ul class="dropdown-menu" data-role="dropdown">
<li><a href="nudtpaper.html">nudtpaper</a></li>
<li><a href="udpip.html" class="current">udp/ip</a></li>
<li><a href="nrf51822.html">nrf51822</a></li>
<li><a href="kicad.html">kicad</a></li>
<li><a href="mathjax.html">mathjax</a></li>
</ul></li>
</ul></nav></div></div>
</header>
<div class="page"><div class="page-content margin20"><div class="page-container">
<h1>UDP/IP &ndash; VHDL based transport protocol</h1>

<p class=readable-text>We interface phy device with FPGA. On Lx9 microboard, a <code>DP83848J</code> phy is used, while on Nexys3, a <code>LAN8710A</code> is used. Both Phy device support standard MII/RMII interface.</p>

<p class=readable-text>I recently (<strong>2014-07-05</strong>) purchased a nexys4 board, where it ships a <code>LAN8720A</code> phy, which supports only RMII interface.</p>
<h2>strap pins</h2>

<p class=readable-text>Configuration straps are latched upon Power-On reset (POR) or pin reset (nRST).</p>
<h3>DP83848J</h3>

<p class=readable-text>MII mode configuration of DP83848J, via power up boot mode (<strong>PU</strong> for pullup, <strong>PD</strong> for pulldown, by default, RX_DV is internally weakly <strong>pulled down</strong>, the default value of <strong>RX_DV is 0</strong>),</p>
<table class="table hovered bordered">
<tr class="r1"><td class="c1"><strong>RX_DV</strong> (pin 39, MII_MODE) </td><td class="c2"> MAC Interface </td></tr>
<tr class="r2"><td class="c1">PD (0) </td><td class="c2"> MII Mode </td></tr>
<tr class="r3"><td class="c1">PU (1) </td><td class="c2"> RMII Mode
</td></tr></table>

<p class=readable-text>PHYAD[4:0] are,</p>
<table class="table hovered bordered">
<tr class="r1"><td class="c1">ADDRESS BIT </td><td class="c2"> <strong>PIN</strong> </td><td class="c3"> <strong>default</strong> </td></tr>
<tr class="r2"><td class="c1">PHYAD[0] </td><td class="c2"> COL </td><td class="c3"> connect to FPGA </td></tr>
<tr class="r3"><td class="c1">PHYAD[1] </td><td class="c2"> RXD0 </td><td class="c3"> connect </td></tr>
<tr class="r4"><td class="c1">PHYAD[2] </td><td class="c2"> RXD1 </td><td class="c3"> connect </td></tr>
<tr class="r5"><td class="c1">PHYAD[3] </td><td class="c2"> RXD2 </td><td class="c3"> connect </td></tr>
<tr class="r6"><td class="c1">PHYAD[4] </td><td class="c2"> RXD3 </td><td class="c3"> connect
</td></tr></table>

<p class=readable-text>About the PHY_ADDRESS. PHYAD4-PHYAD1 is internally <strong>pulled down</strong>, PHYAD0 is internally weakly <strong>pulled up</strong>, the PHY_ADDRESS is by default <code>b&ldquo;00001&rdquo;</code>; if <strong>bitgen</strong> let's unused pins COL/PHYAD0 pulled down, and PHYAD4-PHYAD1 pulled-up as specified in ucf, the PHY_ADDRESS will be altered as <code>b&ldquo;11110&rdquo;</code>. PHY_ADDRESS <code>b&ldquo;00000&rdquo;</code> is not allowed.</p>
<h3>LAN8710A</h3>

<p class=readable-text>PHYAD[2:0] are showed below. LAN8710 uses a SMI interface, where ADDRESS are configured via PHYAD[2:0]. These address are latched into an internal register at the end of hardware reset (default <code>b&ldquo;000&rdquo;</code> ).</p>
<table class="table hovered bordered">
<tr class="r1"><td class="c1">ADDRESS BIT </td><td class="c2"> <strong>PIN</strong> </td><td class="c3"> <strong>default</strong> </td></tr>
<tr class="r2"><td class="c1">PHYAD[0] </td><td class="c2"> RXER </td><td class="c3"> external PD(0) </td></tr>
<tr class="r3"><td class="c1">PHYAD[1] </td><td class="c2"> RXCLK </td><td class="c3"> external PD(0) </td></tr>
<tr class="r4"><td class="c1">PHYAD[2] </td><td class="c2"> RXD3 </td><td class="c3"> external PD(0)
</td></tr></table>

<p class=readable-text>MODE[2:0] bits controls the working mode of phy. Default is <code>b&ldquo;100&rdquo;</code> (you need to pull-up COL in FPGA), works in <em>100Base-TX Half Duplex is advertised. Auto-negotiation enabled. CRS is active during Transmit &amp; Receive.</em></p>
<table class="table hovered bordered">
<tr class="r1"><td class="c1">ADDRESS BIT </td><td class="c2"> <strong>PIN</strong> </td><td class="c3"> <strong>default</strong> </td></tr>
<tr class="r2"><td class="c1">MODE[0] </td><td class="c2"> RXD0 </td><td class="c3"> external PD(0) </td></tr>
<tr class="r3"><td class="c1">MODE[1] </td><td class="c2"> RXD1 </td><td class="c3"> external PD(0) </td></tr>
<tr class="r4"><td class="c1">MODE[2] </td><td class="c2"> COL </td><td class="c3"> connect via 10\(\Omega\) to FPGA
</td></tr></table>

<p class=readable-text>RMIISEL pins (<strong>RXD2</strong>) controls the working mode, with <code>PD (0)</code> works in MII mode, <code>PU (1)</code> in RMII mode. Default is PD(0) in <code>MII</code> mode.</p>
<table class="table hovered bordered">
<tr class="r1"><td class="c1">ADDRESS BIT </td><td class="c2"> <strong>PIN</strong> </td><td class="c3"> <strong>default</strong> </td></tr>
<tr class="r2"><td class="c1">RMIISEL </td><td class="c2"> RXD2 </td><td class="c3"> external PD(0)
</td></tr></table>

<p class=readable-text>Some nots on CRS (Carrier Sense) and COL (Collision Detect).</p>
<ol>
<li><p class="readable-text"><code>CRS:</code> The device asserts CRS
based only on receive activity whenever the transceiver is either in repeater mode or full-duplex mode.
Otherwise the transceiver asserts CRS based on either transmit or receive activity.</p>
</li>
<li><p class="readable-text"><code>COL:</code> A collision is the occurrence of simultaneous transmit and receive operations. The COL output is
asserted to indicate that a collision has been detected. COL remains active for the duration of the
collision. COL is changed asynchronously to both RXCLK and TXCLK. The COL output becomes
inactive during full duplex mode.</p>
</li>
</ol>
<h2>downlink &ndash; receive data from PC and send back via UART interface</h2>
<h2>uplink &ndash; receive data from uart and send to PC via ethernet</h2>
<h2>High-speed full duplex data logging from FPGA to PC</h2>

<p class=readable-text>Most of the time, we collected large amount of data using FPGA and on-chip ADCs, and want sent them direct to PC. Only standard peripherals can be used. Some protocols may bump to our mind, for example, Bluetooth 2.1 (BLE is too slow for data logging), RS232 (where most of the time, we will use CP2102 to convert a serial interface to USB, and utilize the ttyUSBx on PC), wifi and ethernet. Among all these options, UART is the best. It is simple, utilize little FPGA on-chip resources, and the data can be logged in raw format. Most important, I had success with this protocol.</p>

<p class=readable-text>Transparent data transfer using RS232 via bluetooth or wifi, or even ethernet are now available. However, we had this problem : how could we transfer data from FPGA to PC, in high-speed, long-distance, and best of all, with little or no dirty work on excessive complex state machines?</p>
<h1>Ethernet playground</h1>
<h2>play with the hardware using <code>ip</code></h2>

<p class=readable-text>We may control the interface via <code>ip</code> under my archlinux, i.e., <code>ip list</code>, <code>ip link set enp0s25 up</code>, <code>ip addr add ADDR dev enp0s25</code> and <code>ip route add default via ROUTE</code>. All the information can be viewed in <code>wireshark</code>.</p>
<h2>understand the packets (or <em>shells</em>) of OSI-7 layer</h2>

<p class=readable-text>A sample packet (phy&ndash;ip&ndash;udp),</p>
<table class="table hovered bordered">
<tr class="r1"><td class="c1"></td><td class="c2"> 1B </td><td class="c3"> 2B </td><td class="c4"> 3B </td><td class="c5"> 4B </td><td class="c6"> <strong>Note</strong> </td></tr>
<tr class="r2"><td class="c1">Ethernet preamble  </td><td class="c2"> 55 </td><td class="c3"> 55 </td><td class="c4"> 55 </td><td class="c5"> 55 </td><td class="c6"> generated by the chipset </td></tr>
<tr class="r3"><td class="c1"></td><td class="c2"> 55 </td><td class="c3"> 55 </td><td class="c4"> 55 </td><td class="c5"> D5 </td><td class="c6"> </td></tr>
<tr class="r4"><td class="c1">Ethernet MAC (dst) </td><td class="c2"> 01 </td><td class="c3"> 02 </td><td class="c4"> 03 </td><td class="c5"> 04 </td><td class="c6"> src=<strong>01-02-03-04-05-06</strong> </td></tr>
<tr class="r5"><td class="c1">(src) </td><td class="c2"> 05 </td><td class="c3"> 06 </td><td class="c4"> 11 </td><td class="c5"> 12 </td><td class="c6"> dst=<strong>11-12-13-14-15-16</strong> </td></tr>
<tr class="r6"><td class="c1"></td><td class="c2"> 13 </td><td class="c3"> 14 </td><td class="c4"> 15 </td><td class="c5"> 16 </td><td class="c6"> </td></tr>
<tr class="r7"><td class="c1"></td><td class="c2"> 08 </td><td class="c3"> 00 </td><td class="c4">    </td><td class="c5">    </td><td class="c6"> type=IP </td></tr>
<tr class="r8"><td class="c1">IP Header          </td><td class="c2"> 45 </td><td class="c3"> 00 </td><td class="c4"> 00 </td><td class="c5"> <code>2A</code> </td><td class="c6"> #IP=<strong>42B</strong> (0x2A) </td></tr>
<tr class="r9"><td class="c1"></td><td class="c2"> 00 </td><td class="c3"> 00 </td><td class="c4"> 40 </td><td class="c5"> 00 </td><td class="c6"> </td></tr>
<tr class="r10"><td class="c1"></td><td class="c2"> 10 </td><td class="c3"> <code>11</code> </td><td class="c4">  </td><td class="c5">    </td><td class="c6"> type=UDP </td></tr>
<tr class="r11"><td class="c1"><code>IP CRC</code>           </td><td class="c2">    </td><td class="c3">    </td><td class="c4"> CC </td><td class="c5"> 9E </td><td class="c6"> sum-add-inv </td></tr>
<tr class="r12"><td class="c1">IP (src)           </td><td class="c2"> 01 </td><td class="c3"> 23 </td><td class="c4"> 45 </td><td class="c5"> 67 </td><td class="c6"> </td></tr>
<tr class="r13"><td class="c1">IP (dst)           </td><td class="c2"> 89 </td><td class="c3"> AB </td><td class="c4"> CD </td><td class="c5"> EF </td><td class="c6"> </td></tr>
<tr class="r14"><td class="c1">UDP (src/dst)     </td><td class="c2"> 00 </td><td class="c3"> 17 </td><td class="c4"> 17 </td><td class="c5"> 17 </td><td class="c6"> </td></tr>
<tr class="r15"><td class="c1">UDP length         </td><td class="c2"> 00 </td><td class="c3"> <code>16</code> </td><td class="c4">    </td><td class="c5">    </td><td class="c6"> #UDP=<strong>22B</strong> (0x16) </td></tr>
<tr class="r16"><td class="c1"><code>UDP CRC</code>          </td><td class="c2">    </td><td class="c3">    </td><td class="c4"> CB </td><td class="c5"> 75 </td><td class="c6"> sum-add-inv </td></tr>
<tr class="r17"><td class="c1">UDP payload        </td><td class="c2"> 48 </td><td class="c3"> 65 </td><td class="c4"> 6C </td><td class="c5"> 6C </td><td class="c6"> hell </td></tr>
<tr class="r18"><td class="c1"></td><td class="c2"> 6F </td><td class="c3"> 20 </td><td class="c4"> 77 </td><td class="c5"> 6F </td><td class="c6"> o,wo </td></tr>
<tr class="r19"><td class="c1"></td><td class="c2"> 72 </td><td class="c3"> 6C </td><td class="c4"> 64 </td><td class="c5"> 21 </td><td class="c6"> rld! </td></tr>
<tr class="r20"><td class="c1"></td><td class="c2"> 0D </td><td class="c3"> 0A </td><td class="c4">    </td><td class="c5">    </td><td class="c6"> \n\r </td></tr>
<tr class="r21"><td class="c1">UDP padding        </td><td class="c2"> 00 </td><td class="c3"> 00 </td><td class="c4"> 00 </td><td class="c5"> 00 </td><td class="c6"> pad for <strong>46B</strong> minimum </td></tr>
<tr class="r22"><td class="c1"><code>Ethernet CRC</code>     </td><td class="c2"> 52 </td><td class="c3"> 5D </td><td class="c4"> A4 </td><td class="c5"> CF </td><td class="c6"> CRC-32
</td></tr></table>

<p class=readable-text>On the physical wire, bits are transmitted LSB first (bit reversed) in Byte order. For example, <strong>0xD5</strong> is transmitted as <strong>0x5, 0xD</strong> in MII interface and <strong>1010, 1011</strong> on the wire.</p>
<ol>
<li><p class="readable-text">Ethernet CRC is calculate from Ethernet MAC to the last quad-byte (i.e., at the end of UDP padding) of data, use <code>CRC-32</code>. Padding is needed to ensure the total ethernet payload is in <strong>46B~1500B</strong>.</p>
</li>
<li><p class="readable-text">IP CRC is calculate on IP Header only. <strong>A very intuitive example</strong>, see <a href="http://en.wikipedia.org/wiki/IPv4_header_checksum" target=&ldquo;blank&rdquo;>IPv4 header checksum</a> !! Which is simply <code>sum</code>, <code>add carry</code>, and <code>bit-wise inverse</code>.</p>
</li>
<li><p class="readable-text">UDP CRC is calculate on pseudo UDP/IP header. <strong>A very intuitive example</strong>, see <a href="http://en.wikipedia.org/wiki/User_Datagram_Protocol" target=&ldquo;blank&rdquo;>UDP pseudo header checksum</a> !! It forms a pseudo header by encapsulating IP src, dst, <code>0x0011</code> and UDP length, where the udp length is used twice and it stands for the total length of UDP header and data.</p>
</li>
</ol>

<p class=readable-text>Data receive and transmite are simply <code>decap</code> and <code>encap</code> of the packets.</p>
<h3>decap</h3>
<h3>encap</h3>
<h2>play with the swiss-knife <code>wireshark</code></h2>
<h1>GUI frontend</h1>

<p class=readable-text>We are going to use <code>Qt</code> as the GUI frontend.</p>
<h2>Ethernet</h2>

<p class=readable-text>The commercial IP core (Xilinx Tri-MAC) is a complete implementation of a MAC layer. The lx9 microboard has an National Semiconductor DP83848J Phy layer and Tyco RJ45 connector. I found designs which directly use the LVDS pins on FPGA to implement the 10BASE-T protocol (MAC + PHY all in FPGA):</p>
<ol>
<li><p class="readable-text"><a href="http://www.punk.co.nz/2013/03/07/crafting-a-basic-ethernet-mac-and-10base-t-phy/" target=&ldquo;blank&rdquo;>http://www.punk.co.nz/2013/03/07/crafting-a-basic-ethernet-mac-and-10base-t-phy/</a></p>
</li>
<li><p class="readable-text"><a href="http://www.fpga4fun.com/10BASE-T.html" target=&ldquo;blank&rdquo;>http://www.fpga4fun.com/10BASE-T.html</a></p>
</li>
<li><p class="readable-text"><a href="http://midir.fi/?i=ktvwn44y&amp;la=en" target=&ldquo;blank&rdquo;>http://midir.fi/?i=ktvwn44y&amp;la=en</a></p>
</li>
</ol>

<p class=readable-text>and some publicity available code (small state machines) on interfacing with a PHY device. Our targeting PHY interface <strong>DP83848J</strong> might be used in this way, so check out:</p>
<ol>
<li><p class="readable-text"><a href="http://forums.xilinx.com/t5/Spartan-Family-FPGAs/UDP-IP-stack-on-a-Spartan-6/td-p/149492" target=&ldquo;blank&rdquo;>http://forums.xilinx.com/t5/Spartan-Family-FPGAs/UDP-IP-stack-on-a-Spartan-6/td-p/149492</a></p>
</li>
<li><p class="readable-text"><a href="http://www.joelw.id.au/FPGA/DigilentAtlysResources" target=&ldquo;blank&rdquo;>http://www.joelw.id.au/FPGA/DigilentAtlysResources</a></p>
</li>
<li><p class="readable-text"><a href="http://people.ece.cornell.edu/land/courses/ece5760/FinalProjects/f2011/mis47_ayg6/mis47_ayg6/" target=&ldquo;blank&rdquo;>http://people.ece.cornell.edu/land/courses/ece5760/FinalProjects/f2011/mis47_ayg6/mis47_ayg6/</a></p>
</li>
<li><p class="readable-text"><a href="https://www.deyisupport.com/question_answer/dsp_arm/sitara_arm/f/25/t/45981.aspx" target=&ldquo;blank&rdquo;>https://www.deyisupport.com/question_answer/dsp_arm/sitara_arm/f/25/t/45981.aspx</a> In Chinese</p>
</li>
</ol>

<p class=readable-text>An GMAC on opencore.org (I do not like opencores as I had little success in using that website)</p>
<ol>
<li><p class="readable-text"><a href="http://opencores.org/project,ethernet_tri_mode" target=&ldquo;blank&rdquo;>http://opencores.org/project,ethernet_tri_mode</a></p>
</li>
</ol>

<p class=readable-text>Some discussions indicated that, it may not be a wise choice to use FPGA to negotiate with the ethernet protocol, the best choice is a microcontroller.</p>
<ol>
<li><p class="readable-text"><a href="http://www.eevblog.com/forum/microcontrollers/open-(functional!)-core-for-ethernet-vhdl-for-ethernet-spartan-6/?PHPSESSID=f6f35063e39f50fd4818c8ba811cac6f" target=&ldquo;blank&rdquo;>Topic: Open (functional!) core for Ethernet / VHDL for Ethernet - Spartan 6?  (Read 3120 times)</a></p>
</li>
</ol>

<p class=readable-text>as I only had a spartan6 FPGA, a softcore (lattice8 or lattice32, Microblaze) is my third (last) choice.</p>

<p class=readable-text>If crafting an PHY + MAC + IP protocol is not your <strong>job</strong>, then simply using one softcore with light IP stack.</p>
<div class="panel ribbed-amber"><div class="panel-content">
Page generated 2014-12-07 19:14:15 UTC, by <strong>liubenyuan</strong> via a <strong>metro</strong> style <a href="https://github.com/wsshin/jemdoc_mathjax" target="blank">jemdoc+MathJax</a>.
</div></div>
</div></div></div>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript">
</script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    TeX: { equationNumbers: { autoNumber: "AMS" } }
});
</script>
